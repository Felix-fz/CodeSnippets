# 2021年电赛F题 智能送药小车 基础部分实现（单车）

## 01 需求分析

​	系统软件的主要功能分为4部分：

1. 使用PWM驱动电机，对小车进行运动控制。

2. 通过串口获取OpenMV的感兴趣区域引导线判定数据数组，作为循线依据。

3. 通过串口获取K210对路口地标数字识别后转向的判断，作为到达路口后的转向依据。

4. 读取红外距离传感模块数字输出端的数据，作为物药是否已经放置的依据。

   为方便观测，在小车行驶的不同状态会通过不同LED指示灯的亮灭进行提示。

## 02 模块选择

1. 主控：STM32C8T6

2. 数字识别：MAIX BIT

3. 循线：openmv4

4. 药品放置检测：红外传感器

5. 电机：减速比1:120直流电机（无测速）

6. 电机驱动：L298N电机驱动模块

7. 车轮：牛眼轮

![系统框图](F:\NJFU_edu\Class\GraduationProject\论文\picture\系统框图.png)

## 03 C8T6管脚分配

| 模块      | 引脚                                                         |   C8T6   |
| --------- | ------------------------------------------------------------ | :------: |
| L298N     | EA                                                           |   PA0    |
|           | EB                                                           |   PA1    |
|           | IN1                                                          |   PA4    |
|           | IN2                                                          |   PA5    |
|           | IN3                                                          |   PA6    |
|           | IN4                                                          |   PA7    |
| 红外      | DO                                                           |   PB0    |
| MAIX BIT  | IO9(Tx)                                                      | PA3(Rx)  |
|           | IO10(Rx)                                                     | PA2(Tx)  |
| OpenMV    | P4(Tx)                                                       | PB11(Rx) |
|           | P5(rX)                                                       | PV10(Tx) |
| LED_RED   | +                                                            |   PC15   |
| LED_GREEN | +                                                            |   PC14   |
|           | <img src="C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916499354.png" alt="1658916499354"  /> |          |

## 04 功能实现

### 4.1 系统总体流程

![1658915948169](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658915948169.png)

### 4.2 循线

![1658915986790](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658915986790.png)

​	ROI感兴趣区域实现的功能主要分为两大部分，一是对目前车辆行驶依据的直线是否偏移车身中心线进行识别，二是对路口以及停止线进行识别判断。

#### 4.2.1 方向修正

​	对于第一个部分，本模块仿照常用于黑线循线的四路红外传感器循线方式，在拍摄画面范围上半部分自左向右设置四个长宽均为20像素的感兴趣区域（如下图所示），对区域内红色色块进行识别，作为循线直行时车头方向修正的依据（如表所示）。

![1658916050057](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916050057.png)

| ROI   | 01   | 02   | 03   | 04   | 小车运行状态 |
| ----- | ---- | ---- | ---- | ---- | :----------: |
| 状态1 | 0    | 0    | 1    | 0    |   向右修正   |
| 状态2 | 0    | 0    | 1    | 1    | 向右大幅修正 |
| 状态2 | 0    | 0    | 0    | 1    | 向右大幅修正 |
| 状态4 | 0    | 0    | 0    | 0    |     前进     |
| 状态5 | 0    | 1    | 0    | 0    |   向左修正   |
| 状态6 | 1    | 1    | 0    | 0    | 向左大幅修正 |
| 状态7 | 1    | 0    | 0    | 0    | 向左大幅修正 |
| 状态8 | 1    | 1    | 1    | 1    |   不作判断   |

#### 4.2.2 路口判断

​	对于第二个部分，由分析可得，小车在行驶过程中可能遇到的道路的情况如图罗列。路口有四种情况，停止线和直行道路均只有一种情况。

| ![img](file:///C:\Users\admin\AppData\Local\Temp\ksohtml428\wps1.jpg) | ![img](file:///C:\Users\admin\AppData\Local\Temp\ksohtml428\wps2.jpg) | ![img](file:///C:\Users\admin\AppData\Local\Temp\ksohtml428\wps3.jpg) |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![img](file:///C:\Users\admin\AppData\Local\Temp\ksohtml428\wps4.jpg) | ![img](file:///C:\Users\admin\AppData\Local\Temp\ksohtml428\wps5.jpg) | ![img](file:///C:\Users\admin\AppData\Local\Temp\ksohtml428\wps6.jpg) |

​	所以，如要对以上道路情况进行分类和区分，需额外设定其他感兴趣进行判断。本模块在画面最上方自左向右设置三个ROI区域，如图所示（红色框）：

![1658916250104](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916250104.png)

​	当有两个及以上数量的区域识别到红色色块，则说明到达路口，当三个区域均未检测到红色色块，则说明到达停止线区域。对于路口和停止线判断依据对照如表所示：

| ROI   | 左   | 中   | 右   | 道路情况 |
| ----- | ---- | ---- | ---- | :------: |
| 状态1 | 0    | 1    | 0    | 直行道路 |
| 状态2 | 0    | 0    | 0    |  停止线  |
| 状态2 | 1    | 1    | 0    | 左转路口 |
| 状态4 | 0    | 1    | 1    | 右转路口 |
| 状态5 | 1    | 1    | 1    | 十字路口 |

#### 4.2.3 与主控通信

​	使用串口通信，数据帧格式如下：

| 帧头 | 有效数据段（7字节） | 帧尾         |                           |      |
| ---- | ------------------- | ------------ | ------------------------- | ---- |
| 0x55 | 路口标识符          | 停止线标识符 | 五路ROI感兴趣区域识别数组 | 0x56 |

#### 4.2.4 测试

​	结果能准确在设定的感兴趣区域内识别到红线，并将对应标志位置一。运行结果部分展示如图所示。依次为识别到十字路口is_cross标志位置一，识别到T字路口is_cross标志位置一，识别到终止线is_end标志位置一，循线过程中车头方向右偏时左侧感兴趣区域识别到红线。

![1658916717107](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916717107.png)

![1658916729192](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916729192.png)

![1658916747343](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916747343.png)

### 4.3 数字识别

![1658916344250](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916344250.png)

#### 4.3.1 识别

​	通过kpu.run_yolo2(task, img)函数调用训练完成的模型进行数字检测。如果有目标数字，则可读取目标标注，判断具体数字，并且通过rect()函数读取目标的二维坐标以及整体长宽信息，从而可通过其坐标对其处于画面中的左侧还是右侧进行判断，通过串口向主控返回下一路口的转向，如果在画面左侧，则传输指令告知小车下一步左转，如果在画面右侧，则右转。

#### 4.3.2 测试

![1658916843487](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916843487.png)

![1658916851135](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1658916851135.png)



### 4.4 药品放置检测

​	物药放置检测主要通过IO口读取与红外对管传感模块的数字输出端输出的电平进行判断，在主程序循环中不单独调用，仅在车辆起步前和到达病房后进行调用进行判断。

